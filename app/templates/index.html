<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Графики формул</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="bg-dark text-light">
<div class="container py-5">
    <h1 class="mb-4">Генератор графиков формул</h1>

    {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <form method="post" action="/plot">
        <!-- Выбор формулы -->
        <div class="mb-3">
            <label for="formula" class="form-label">Выберите формулу</label>
            <select class="form-select" id="formula" name="formula" required>
                <option value="linear" {% if selected_formula == 'linear' %}selected{% endif %}>Линейная (y = k*x + b)</option>
                <option value="quadratic" {% if selected_formula == 'quadratic' %}selected{% endif %}>Квадратичная (y = a*x^2 + b*x + c)</option>
                <option value="exponential" {% if selected_formula == 'exponential' %}selected{% endif %}>Экспоненциальная (y = a*exp(b*x))</option>
                <option value="logarithmic" {% if selected_formula == 'logarithmic' %}selected{% endif %}>Логарифмическая (y = a*log(x) + b)</option>
                <option value="sinusoidal" {% if selected_formula == 'sinusoidal' %}selected{% endif %}>Синусоидальная (y = a*sin(b*x + c))</option>
            </select>
        </div>

        <!-- X значения -->
        <div class="mb-3">
            <label for="x_values" class="form-label">X значения (через запятую)</label>
            <input type="text" class="form-control" id="x_values" name="x_values"
                   placeholder="0,1,2,3,4,5"
                   value="{{ x_values_value }}">
        </div>

        <!-- Параметры для формул -->
        <div id="param_k_div" class="mb-3">
            <label for="param_k" class="form-label">k / a</label>
            <input type="number" step="any" class="form-control" id="param_k" name="param1"
                   value="{{ param1_value if param1_value is not none else settings.default_linear_k }}">
        </div>

        <div id="param_b_div" class="mb-3">
            <label for="param_b" class="form-label">b</label>
            <input type="number" step="any" class="form-control" id="param_b" name="param2"
                   value="{{ param2_value if param2_value is not none else settings.default_linear_b }}">
        </div>

        <div id="param_c_div" class="mb-3">
            <label for="param_c" class="form-label">c</label>
            <input type="number" step="any" class="form-control" id="param_c" name="param3"
                   value="{{ param3_value if param3_value is not none else settings.default_quadratic_c }}">
        </div>

        <button type="submit" class="btn btn-primary">Построить график</button>
    </form>

    <!-- График -->
    <div class="mt-5">
        {% if graph %}
            {{ graph | safe }}
        {% endif %}
    </div>
</div>

<script>
const defaultParams = {{ default_params | tojson }};

// Элементы input
const paramKDiv = document.getElementById("param_k_div");
const paramBDiv = document.getElementById("param_b_div");
const paramCDiv = document.getElementById("param_c_div");
const formulaSelect = document.getElementById("formula");

function updateParams() {
    const formula = formulaSelect.value;

    if (formula === "linear") {
        paramKDiv.querySelector("label").textContent = "k";
        paramKDiv.style.display = "block";
        paramBDiv.querySelector("label").textContent = "b";
        paramBDiv.style.display = "block";
        paramCDiv.style.display = "none";

        // Подставляем значение только если поле пустое
        if (!paramKDiv.dataset.userEdited && paramKDiv.querySelector("input").value === "") {
            paramKDiv.querySelector("input").value = "{{ settings.default_linear_k }}";
        }
        if (!paramBDiv.dataset.userEdited && paramBDiv.querySelector("input").value === "") {
            paramBDiv.querySelector("input").value = "{{ settings.default_linear_b }}";
        }

    } else if (formula === "quadratic") {
        paramKDiv.querySelector("label").textContent = "a";
        paramKDiv.style.display = "block";
        paramBDiv.querySelector("label").textContent = "b";
        paramBDiv.style.display = "block";
        paramCDiv.style.display = "block";

        if (!paramKDiv.dataset.userEdited && paramKDiv.querySelector("input").value === "") {
            paramKDiv.querySelector("input").value = "{{ settings.default_quadratic_a }}";
        }
        if (!paramBDiv.dataset.userEdited && paramBDiv.querySelector("input").value === "") {
            paramBDiv.querySelector("input").value = "{{ settings.default_quadratic_b }}";
        }
        if (!paramCDiv.dataset.userEdited && paramCDiv.querySelector("input").value === "") {
            paramCDiv.querySelector("input").value = "{{ settings.default_quadratic_c }}";
        }

    } else if (formula === "exponential") {
        paramKDiv.querySelector("label").textContent = "a";
        paramKDiv.style.display = "block";
        paramBDiv.querySelector("label").textContent = "b";
        paramBDiv.style.display = "block";
        paramCDiv.style.display = "none";

        if (!paramKDiv.dataset.userEdited && paramKDiv.querySelector("input").value === "") {
            paramKDiv.querySelector("input").value = "{{ settings.default_exponential_a }}";
        }
        if (!paramBDiv.dataset.userEdited && paramBDiv.querySelector("input").value === "") {
            paramBDiv.querySelector("input").value = "{{ settings.default_exponential_b }}";
        }
    }
}

// Обновляем при загрузке страницы и при смене формулы
updateParams();
formulaSelect.addEventListener("change", updateParams);
</script>
</body>
</html>